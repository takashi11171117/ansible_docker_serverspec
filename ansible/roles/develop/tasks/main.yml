- name: install via apk
  apk: name="{{ item }}" state=latest
  with_items:
    - git
    - jq
    - tar
    - gcc
    - openssl-dev
    - yaml-dev
    - libffi
    - readline-dev
    - zlib-dev
    - gdbm-dev
    - ncurses-dev
    - docker
  become: yes

- name: docker enabled
  service: name=docker enabled=yes state=started
  become: yes

- name: git clone repos
  git: repo={{ item.repo }} dest={{ item.dest }} accept_hostkey=yes
  with_items:
    - { repo: "https://github.com/sstephenson/rbenv", dest: "/home/{{ wheel_user_name }}/.rbenv" }
    - { repo: "https://github.com/sstephenson/ruby-build", dest: "/home/{{ wheel_user_name }}/.rbenv/plugins/ruby-build" }
    - { repo: "https://github.com/dcarley/rbenv-sudo", dest: "/home/{{ wheel_user_name }}/.rbenv/plugins/rbenv-sudo" }

- name: install ruby-build
  shell: sh /home/{{ wheel_user_name }}/.rbenv/plugins/ruby-build/install.sh
  become: yes

# ruby
- name: check ruby installed
  shell: /home/{{ wheel_user_name }}/.rbenv/bin/rbenv versions | grep {{ ruby_version }}
  register: ruby_installed_check
  failed_when: ruby_installed_check.rc not in [0, 1]

- name: install ruby
  shell: /home/{{ wheel_user_name }}/.rbenv/bin/rbenv install {{ ruby_version }}
  when: ruby_installed_check.rc == 1

- name: check default ruby version
  shell: /home/{{ wheel_user_name }}/.rbenv/bin/rbenv version | grep {{ ruby_version }}
  register: ruby_version_check
  failed_when: ruby_version_check.rc not in [0, 1]

- name: set default ruby version
  shell: /home/{{ wheel_user_name }}/.rbenv/bin/rbenv global {{ ruby_version }}
  when: ruby_version_check.rc == 1

- name: update gems and install bundler
  shell: /home/{{ wheel_user_name }}/.rbenv/bin/rbenv exec gem update --system && /home/{{ wheel_user_name }}/.rbenv/bin/rbenv exec gem install bundler --no-ri --no-rdoc && /home/{{ wheel_user_name }}/.rbenv/bin/rbenv rehash
